<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scripture Insight Details</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
        .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 30px; }
        .back-link { color: #3498db; text-decoration: none; display: inline-block; margin-bottom: 20px; }
        .insight-title { font-size: 1.5em; font-weight: bold; margin-bottom: 20px; color: #2c3e50; }
        .insight-content { margin-bottom: 20px; line-height: 1.6; }
        .insight-tags { color: #666; margin-bottom: 20px; }
        .insight-actions { margin-top: 20px; }
        .btn { background: #3498db; color: #fff; border: none; border-radius: 4px; padding: 8px 16px; cursor: pointer; margin-right: 8px; }
        .btn:disabled { background: #ccc; cursor: not-allowed; }
        .modal { display: none; position: fixed; z-index: 10; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background: rgba(0,0,0,0.3); }
        .modal-content { background: #fff; margin: 10% auto; padding: 20px; border-radius: 8px; max-width: 500px; }
        .related-insights { margin-top: 30px; }
        .related-insight { background: #f8f9fa; border-radius: 4px; padding: 15px; margin-bottom: 10px; }
        .related-insight-title { font-weight: bold; margin-bottom: 5px; }
        .related-insight-tags { color: #666; font-size: 0.9em; }
        #logoutBtn { float: right; margin-top: 10px; }
        #userRole { float: right; margin-top: 10px; margin-right: 10px; color: #888; }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
</head>
<body>
    <div class="container">
        <a href="scripture.html" class="back-link">&larr; Back to Scripture Insights</a>
        <span id="userRole"></span>
        <button id="logoutBtn" style="display:none;">Logout</button>

        <!-- Login Form -->
        <div id="login-section">
            <h2>Login</h2>
            <form id="loginForm">
                <input type="email" id="loginEmail" placeholder="Email" required>
                <input type="password" id="loginPassword" placeholder="Password" required>
                <button type="submit" class="btn">Login</button>
            </form>
            <button id="resetPasswordBtn" class="btn" style="margin-top:10px;">Forgot Password?</button>
            <div id="loginError" style="color:red; margin-top:10px;"></div>
        </div>

        <!-- Insight Content -->
        <div id="insight-content" style="display:none;">
            <h1 id="insightTitle" class="insight-title"></h1>
            <div id="insightTags" class="insight-tags"></div>
            <div id="insightContent" class="insight-content"></div>
            <div class="insight-actions">
                <button id="editBtn" class="btn" style="display:none;">Edit</button>
                <button id="deleteBtn" class="btn" style="display:none;">Delete</button>
                <button id="printBtn" class="btn">Print</button>
            </div>
        </div>

        <!-- Related Insights -->
        <div id="relatedInsights" class="related-insights"></div>
    </div>

    <!-- Edit Modal -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <h2>Edit Insight</h2>
            <form id="editForm">
                <input type="text" id="editTitle" placeholder="Title" required style="width:100%;margin-bottom:10px;">
                <div id="quillEditor" style="height:200px;margin-bottom:10px;"></div>
                <input type="text" id="editTags" placeholder="Tags (comma separated)" style="width:100%;margin-bottom:10px;">
                <button type="submit" class="btn">Save Changes</button>
                <button type="button" class="btn" id="cancelEditBtn" style="background:#aaa;">Cancel</button>
            </form>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
    // --- Firebase Config ---
    const firebaseConfig = {
        apiKey: "AIzaSyBXyOXGktacbjg-X2tuVsmJ7nYLCwJZ5Nw",
        authDomain: "comefollowme-d097a.firebaseapp.com",
        projectId: "comefollowme-d097a",
        storageBucket: "comefollowme-d097a.firebasestorage.app",
        messagingSenderId: "725941283112",
        appId: "1:725941283112:web:7071276f065bb3b7dd081d",
        measurementId: "G-Z9HKN7M5K5"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // --- Quill Editor ---
    let quill;
    document.addEventListener('DOMContentLoaded', () => {
        quill = new Quill('#quillEditor', {
            theme: 'snow',
            modules: {
                toolbar: [
                    [{ header: [1, 2, false] }],
                    ['bold', 'italic', 'underline'],
                    [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                    ['link'],
                    [{ 'align': [] }],
                    ['clean']
                ]
            }
        });
    });

    // --- Auth State & Role Management ---
    let currentUser = null;
    let currentUserRole = null;
    let currentInsightId = null;

    function showLogin(show) {
        document.getElementById('login-section').style.display = show ? 'block' : 'none';
        document.getElementById('insight-content').style.display = show ? 'none' : 'block';
        document.getElementById('logoutBtn').style.display = show ? 'none' : 'inline-block';
        updateEditButtons();
    }

    function canEdit() {
        return currentUser && (currentUserRole === 'admin' || currentUserRole === 'editor');
    }

    function updateRoleUI() {
        document.getElementById('userRole').textContent = currentUserRole ? `Role: ${currentUserRole}` : '';
        updateEditButtons();
    }

    function updateEditButtons() {
        const canEditInsight = canEdit();
        document.getElementById('editBtn').style.display = canEditInsight ? 'inline-block' : 'none';
        document.getElementById('deleteBtn').style.display = canEditInsight ? 'inline-block' : 'none';
    }

    auth.onAuthStateChanged(async user => {
        currentUser = user;
        if (user) {
            const userDoc = await db.collection('users').doc(user.uid).get();
            currentUserRole = userDoc.exists ? userDoc.data().role : 'user';
            showLogin(false);
            updateRoleUI();
            loadInsight();
        } else {
            currentUserRole = null;
            showLogin(true);
            updateRoleUI();
        }
    });

    // --- Login/Logout ---
    document.getElementById('loginForm').addEventListener('submit', async e => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        try {
            await auth.signInWithEmailAndPassword(email, password);
            document.getElementById('loginError').textContent = '';
        } catch (err) {
            document.getElementById('loginError').textContent = err.message;
        }
    });

    document.getElementById('logoutBtn').addEventListener('click', () => {
        auth.signOut();
    });

    // --- Password Reset ---
    document.getElementById('resetPasswordBtn').addEventListener('click', async () => {
        const email = document.getElementById('loginEmail').value;
        if (!email) {
            document.getElementById('loginError').textContent = 'Enter your email to reset password.';
            return;
        }
        try {
            await auth.sendPasswordResetEmail(email);
            document.getElementById('loginError').textContent = 'Password reset email sent!';
        } catch (err) {
            document.getElementById('loginError').textContent = err.message;
        }
    });

    // --- Load Insight ---
    async function loadInsight() {
        const urlParams = new URLSearchParams(window.location.search);
        currentInsightId = urlParams.get('id');
        if (!currentInsightId) {
            alert('No insight ID provided');
            return;
        }

        const doc = await db.collection('scriptureInsights').doc(currentInsightId).get();
        if (!doc.exists) {
            alert('Insight not found');
            return;
        }

        const data = doc.data();
        document.getElementById('insightTitle').textContent = data.title;
        document.getElementById('insightTags').textContent = `Tags: ${data.tags || ''}`;
        document.getElementById('insightContent').innerHTML = data.content;

        // Load related insights
        loadRelatedInsights(data.tags);
    }

    // --- Related Insights ---
    async function loadRelatedInsights(tags) {
        if (!tags) return;
        const tagArray = tags.split(',').map(tag => tag.trim());
        const snapshot = await db.collection('scriptureInsights')
            .where('tags', 'array-contains-any', tagArray)
            .limit(5)
            .get();

        const container = document.getElementById('relatedInsights');
        container.innerHTML = '<h3>Related Insights</h3>';
        
        snapshot.forEach(doc => {
            if (doc.id === currentInsightId) return; // Skip current insight
            const data = doc.data();
            const div = document.createElement('div');
            div.className = 'related-insight';
            div.innerHTML = `
                <div class="related-insight-title">${data.title}</div>
                <div class="related-insight-tags">Tags: ${data.tags || ''}</div>
                <a href="insight-scripture.html?id=${doc.id}" class="btn">View</a>
            `;
            container.appendChild(div);
        });
    }

    // --- Edit Modal ---
    const editModal = document.getElementById('editModal');
    const editForm = document.getElementById('editForm');

    document.getElementById('editBtn').onclick = async () => {
        if (!canEdit()) return;
        const doc = await db.collection('scriptureInsights').doc(currentInsightId).get();
        const data = doc.data();
        document.getElementById('editTitle').value = data.title;
        quill.root.innerHTML = data.content;
        document.getElementById('editTags').value = data.tags || '';
        editModal.style.display = 'block';
    };

    document.getElementById('cancelEditBtn').onclick = () => {
        editModal.style.display = 'none';
    };

    editForm.onsubmit = async e => {
        e.preventDefault();
        if (!canEdit()) return;
        const title = document.getElementById('editTitle').value;
        const content = quill.root.innerHTML;
        const tags = document.getElementById('editTags').value;
        await db.collection('scriptureInsights').doc(currentInsightId).update({
            title, content, tags
        });
        editModal.style.display = 'none';
        loadInsight();
    };

    // --- Delete Insight ---
    document.getElementById('deleteBtn').onclick = async () => {
        if (!canEdit()) return;
        if (confirm('Delete this insight?')) {
            await db.collection('scriptureInsights').doc(currentInsightId).delete();
            window.location.href = 'scripture.html';
        }
    };

    // --- Print Insight ---
    document.getElementById('printBtn').onclick = () => {
        window.print();
    };

    // --- Hide modal on outside click ---
    window.onclick = function(event) {
        if (event.target == editModal) editModal.style.display = 'none';
    };
    </script>
</body>
</html>