<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Other Insight Details</title>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: #f5f5f5; margin: 0; padding: 0; }
        .container { max-width: 700px; margin: 40px auto; background: #fff; border-radius: 8px; box-shadow: 0 2px 8px #0001; padding: 30px; }
        .back-link { color: #3498db; text-decoration: none; margin-bottom: 20px; display: inline-block; }
        .back-link:hover { text-decoration: underline; }
        h1 { color: #2c3e50; }
        .tags { margin: 10px 0; color: #888; }
        .actions { margin-top: 20px; }
        .actions button { margin-right: 10px; }
        .related-section { margin-top: 30px; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: #fff; margin: 10% auto; padding: 20px; width: 90%; max-width: 500px; border-radius: 8px; position: relative; }
        .close-button { position: absolute; right: 20px; top: 10px; font-size: 24px; cursor: pointer; color: #666; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; color: #2c3e50; }
        .form-group input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>
    <div class="container">
        <a class="back-link" href="other.html">&larr; Back to Other Insights</a>
        <h1 id="insight-title"></h1>
        <div id="insight-content"></div>
        <div class="tags"><strong>Tags:</strong> <span id="insight-tags"></span></div>
        <div class="actions">
            <button id="edit-btn">Edit</button>
            <button id="delete-btn">Delete</button>
            <button id="print-btn">Print</button>
        </div>
        <div class="related-section">
            <h3>Related Insights</h3>
            <ul id="related-list"></ul>
            <select id="add-related-select"></select>
            <button id="add-related-btn">Add Related</button>
        </div>
    </div>
    <!-- Edit Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="edit-cancel">&times;</span>
            <h2>Edit Insight</h2>
            <div class="form-group">
                <label for="edit-title">Title</label>
                <input type="text" id="edit-title">
            </div>
            <div class="form-group">
                <label for="edit-content">Content</label>
                <div id="edit-content" style="height: 150px;"></div>
            </div>
            <div class="form-group">
                <label for="edit-tags">Tags (comma-separated)</label>
                <input type="text" id="edit-tags">
            </div>
            <button id="edit-save">Save</button>
        </div>
    </div>
    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBXyOXGktacbjg-X2tuVsmJ7nYLCwJZ5Nw",
            authDomain: "comefollowme-d097a.firebaseapp.com",
            projectId: "comefollowme-d097a",
            storageBucket: "comefollowme-d097a.firebasestorage.app",
            messagingSenderId: "725941283112",
            appId: "1:725941283112:web:7071276f065bb3b7dd081d",
            measurementId: "G-Z9HKN7M5K5"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        function getQueryParam(name) {
            const url = new URL(window.location.href);
            return url.searchParams.get(name);
        }
        const insightId = getQueryParam('id');
        let currentInsight = null;
        let allInsights = [];
        let quill;

        document.addEventListener('DOMContentLoaded', async () => {
            quill = new Quill('#edit-content', {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ header: [1, 2, false] }],
                        ['bold', 'italic', 'underline'],
                        [{ 'align': [] }],
                        ['link', 'image'],
                        [{ 'list': 'ordered'}, { 'list': 'bullet' }]
                    ]
                }
            });
            await loadAllInsights();
            await loadInsight();
            setupEditForm();
            setupDelete();
            setupRelated();
        });

        async function loadAllInsights() {
            const snapshot = await db.collection('otherInsights').get();
            allInsights = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        }

        async function loadInsight() {
            if (!insightId) return;
            const doc = await db.collection('otherInsights').doc(insightId).get();
            if (!doc.exists) {
                document.getElementById('insight-title').textContent = 'Insight not found';
                document.getElementById('insight-content').innerHTML = '';
                document.getElementById('insight-tags').textContent = '';
                return;
            }
            currentInsight = { id: doc.id, ...doc.data() };
            renderInsight();
        }

        function renderInsight() {
            document.getElementById('insight-title').textContent = currentInsight.title;
            document.getElementById('insight-content').innerHTML = currentInsight.content;
            document.getElementById('insight-tags').textContent = (currentInsight.tags || []).join(', ');
            renderRelated();
            document.getElementById('edit-title').value = currentInsight.title;
            quill.root.innerHTML = currentInsight.content;
            document.getElementById('edit-tags').value = (currentInsight.tags || []).join(', ');
        }

        function setupEditForm() {
            document.getElementById('edit-btn').onclick = () => {
                document.getElementById('edit-modal').style.display = 'block';
            };
            document.getElementById('edit-cancel').onclick = () => {
                document.getElementById('edit-modal').style.display = 'none';
            };
            document.getElementById('edit-save').onclick = async () => {
                const updated = {
                    title: document.getElementById('edit-title').value,
                    content: quill.root.innerHTML,
                    tags: document.getElementById('edit-tags').value.split(',').map(t => t.trim()).filter(Boolean),
                    related: currentInsight.related || []
                };
                await db.collection('otherInsights').doc(insightId).update(updated);
                currentInsight = { ...currentInsight, ...updated };
                renderInsight();
                document.getElementById('edit-modal').style.display = 'none';
            };
        }

        function setupDelete() {
            document.getElementById('delete-btn').onclick = async () => {
                if (confirm('Delete this insight?')) {
                    await db.collection('otherInsights').doc(insightId).delete();
                    window.location.href = 'other.html';
                }
            };
        }

        function renderRelated() {
            const relatedList = document.getElementById('related-list');
            relatedList.innerHTML = '';
            if (!currentInsight.related || !currentInsight.related.length) {
                relatedList.innerHTML = '<li>No related insights.</li>';
                return;
            }
            currentInsight.related.forEach(relId => {
                const rel = allInsights.find(i => i.id === relId);
                if (rel) {
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="insight-other.html?id=${rel.id}">${rel.title}</a>
                        <button onclick="unlinkRelated('${rel.id}')">Unlink</button>`;
                    relatedList.appendChild(li);
                }
            });
        }

        window.unlinkRelated = async function(relId) {
            currentInsight.related = (currentInsight.related || []).filter(id => id !== relId);
            await db.collection('otherInsights').doc(insightId).update({ related: currentInsight.related });
            renderRelated();
        };

        function setupRelated() {
            const select = document.getElementById('add-related-select');
            select.innerHTML = '';
            allInsights
                .filter(i => i.id !== insightId)
                .forEach(i => {
                    const option = document.createElement('option');
                    option.value = i.id;
                    option.textContent = i.title;
                    select.appendChild(option);
                });
            document.getElementById('add-related-btn').onclick = async () => {
                const relId = select.value;
                if (!relId || (currentInsight.related || []).includes(relId)) return;
                currentInsight.related = [...(currentInsight.related || []), relId];
                await db.collection('otherInsights').doc(insightId).update({ related: currentInsight.related });
                renderRelated();
            };
        }

        document.getElementById('print-btn').onclick = () => {
            const notesPage = confirm('Include a notes page?');
            let printContent = `
                <h1>${currentInsight.title}</h1>
                <div>${currentInsight.content}</div>
                <div><strong>Tags:</strong> ${(currentInsight.tags || []).join(', ')}</div>
                <h2>Related Insights</h2>
                <ul>
                    ${(currentInsight.related || []).map(relId => {
                        const rel = allInsights.find(i => i.id === relId);
                        return rel ? `<li>${rel.title}</li>` : '';
                    }).join('')}
                </ul>
            `;
            if (notesPage) {
                printContent += `
                    <div style="page-break-before: always;">
                        <h2>Notes</h2>
                        <div style="height:900px; border:1px solid #ccc; margin-top:20px;">
                            <div style="height:100%; border-top:1px dashed #aaa; margin-bottom:20px; line-height:2.5em;">
                                ${'<div style="border-bottom:1px dashed #aaa; height:2.5em;"></div>'.repeat(20)}
                            </div>
                        </div>
                    </div>
                `;
            }
            const win = window.open('', '', 'width=800,height=900');
            win.document.write(`<html><head><title>Print Insight</title></head><body>${printContent}</body></html>`);
            win.print();
            win.close();
        };
    </script>
</body>
</html>